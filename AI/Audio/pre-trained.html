<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Honk vs Emergency Sound Detection</title>
</head>
<body>
  <h2>Honk vs Emergency Sound Classifier</h2>

  <input type="file" id="audioInput" accept="audio/*" />
  <p id="status">Load an audio file (.wav / .mp3)</p>

  <pre id="output"></pre>

  <!-- Transformers.js -->
<script type="module">
  import { pipeline } from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1";

  const input = document.getElementById("audioInput");
  const output = document.getElementById("output");
  const status = document.getElementById("status");

  status.textContent = "Loading model...";

  const classifier = await pipeline(
    "audio-classification",
    "onnx-community/ast-finetuned-audioset-10-10-0.4593-ONNX"
  );

  status.textContent = "Model loaded. Upload audio.";

  input.addEventListener("change", async () => {
    const file = input.files[0];
    if (!file) return;

    status.textContent = "Decoding audio...";

    // 1️⃣ Decode audio
    const arrayBuffer = await file.arrayBuffer();
    const audioContext = new AudioContext({ sampleRate: 16000 });
    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

    // 2️⃣ Get mono channel data
    const audioData = audioBuffer.getChannelData(0);

    status.textContent = "Running inference...";

    // 3️⃣ Run classifier on Float32Array
    const results = await classifier(audioData, { topk: 10 });

    // 4️⃣ Filter horn vs emergency
    const filtered = results.filter(r =>
      r.label.toLowerCase().includes("siren") ||
      r.label.toLowerCase().includes("horn")
    );

    output.textContent = filtered
      .map(r => `${r.label}: ${(r.score * 100).toFixed(2)}%`)
      .join("\n");

    status.textContent = "Done.";
  });
</script>
</body>
</html>
