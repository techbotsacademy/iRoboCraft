<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Audio â†’ Arduino (Working Version)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; background: #f4f7f6; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 600px; margin: auto; }
        #status { font-weight: bold; color: #d9534f; }
        #label-container div { margin: 5px 0; padding: 5px; border-bottom: 1px solid #eee; }
        button { padding: 10px 20px; font-size: 1rem; cursor: pointer; border-radius: 5px; border: none; background: #3498db; color: white; margin-right: 10px; }
        button:hover { background: #2980b9; }
        .prediction-highlight { font-size: 1.5em; color: #27ae60; margin-top: 15px; font-weight: bold; }
        input { width: 100%; padding: 8px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="card">
    <h2>ðŸš¨ Sound Detection to Arduino</h2>

    <!-- âœ… Editable Model URL -->
    <label><strong>Teachable Machine Model URL:</strong></label>
    <input
        type="text"
        id="modelURL"
        value="https://teachablemachine.withgoogle.com/models/HRLEKQWxR/"
    />

    <p>Status: <span id="status">Idle</span></p>

    <div class="controls">
        <button onclick="connectArduino()">ðŸ”Œ 1. Connect Arduino</button>
        <button onclick="init()">ðŸŽ¤ 2. Start Listening</button>
    </div>

    <div id="label-container"></div>
    <div class="prediction-highlight" id="top-prediction">Top: --</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

<script type="text/javascript">
    let recognizer, port, writer;
    let lastAmbulanceTime = 0;
    const COOLDOWN_MS = 60000; // 1 minute cooldown

    // 1. Connect to Arduino via Web Serial
    async function connectArduino() {
        try {
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 9600 });
            writer = port.writable.getWriter();
            document.getElementById("status").innerText = "Arduino Connected âœ…";
            document.getElementById("status").style.color = "green";
        } catch (err) {
            console.error(err);
            alert("Serial Connection Failed. Use Chrome/Edge.");
        }
    }

    async function createModel() {
        const baseURL = document.getElementById("modelURL").value.trim();

        const checkpointURL = baseURL + "model.json";
        const metadataURL = baseURL + "metadata.json";

        const recognizer = speechCommands.create(
            "BROWSER_FFT",
            undefined,
            checkpointURL,
            metadataURL
        );

        await recognizer.ensureModelLoaded();
        return recognizer;
    }

    // 2. Start Model and Microphone
    async function init() {
        const status = document.getElementById("status");
        status.innerText = "Loading Model...";

        recognizer = await createModel();
        const classLabels = recognizer.wordLabels();
        const labelContainer = document.getElementById("label-container");

        labelContainer.innerHTML = "";
        for (let i = 0; i < classLabels.length; i++) {
            labelContainer.appendChild(document.createElement("div"));
        }

        status.innerText = "Listening... ðŸŽ¤";
        status.style.color = "blue";

        recognizer.listen(result => {
            let highestScore = 0;
            let highestLabel = "";

            for (let i = 0; i < classLabels.length; i++) {
                const score = result.scores[i];
                labelContainer.childNodes[i].innerHTML =
                    classLabels[i] + ": " + score.toFixed(2);

                if (score > highestScore) {
                    highestScore = score;
                    highestLabel = classLabels[i];
                }
            }

            document.getElementById("top-prediction").innerText =
                `Top: ${highestLabel}`;

            if (highestScore > 0.85) {
                handleArduinoLogic(highestLabel);
            }
        }, {
            includeSpectrogram: false,
            probabilityThreshold: 0.75,
            invokeCallbackOnNoiseAndUnknown: true,
            overlapFactor: 0.5
        });
    }

    async function handleArduinoLogic(label) {
        if (!writer) return;

        const now = Date.now();

        if (label === "Ambulance") {
            if (now - lastAmbulanceTime > COOLDOWN_MS) {
                await sendToArduino("A");
                lastAmbulanceTime = now;
            }
        }
        else if (label === "Horn") {
            if (now - lastAmbulanceTime > COOLDOWN_MS) {
                await sendToArduino("H");
            }
        }
        else {
            await sendToArduino("B");
        }
    }

    async function sendToArduino(char) {
        const data = new TextEncoder().encode(char);
        await writer.write(data);
    }
</script>

</body>
</html>
